<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Test Summary (XLSX Supported)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial; background:#eef2f7; padding:20px; }
  .container { max-width:1300px; margin:auto; background:#fff; padding:20px; border-radius:10px; }
  h1,h2 { text-align:center; margin:20px 0; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border:1px solid #ccc; padding:8px; text-align:center; }
  thead { background:#2563eb; color:#fff; }
  tr:nth-child(even){ background:#f1f5ff; }
  button { padding:10px 15px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer; margin:8px 0; }
</style>
</head>

<body>
<div class="container">

  <h1>Test Summary</h1>

  <label><b>Upload Excel (.xlsx):</b>
    <input type="file" id="excelFile" accept=".xlsx">
  </label>

  <h2>Table 1: Overall Test Count (Ignore Status)</h2>
  <button id="downloadOverall">Download Overall CSV</button>
  <table id="overallTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Test Name</th>
        <th>Total Count</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Table 2: Date-wise Test Count</h2>
  <button id="downloadDatewise">Download Datewise CSV</button>
  <table id="datewiseTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Date</th>
        <th>Test Name</th>
        <th>Count</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<script>
document.getElementById("excelFile").addEventListener("change", handleFile);

let overallData = [];
let datewiseData = [];

function handleFile(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval:"" });
    process(rows);
  };
  reader.readAsArrayBuffer(file);
}

// Extract only date (ignore time)
function extractDate(v) {
  if (!v) return "";
  if (!isNaN(v)) {
    const base = new Date(1899,11,30);
    return new Date(base.getTime() + v*86400000).toLocaleDateString("en-GB");
  }
  return v.split(" ")[0].trim();
}

function process(rows) {
  const overallMap = new Map();
  const dateMap = new Map();

  rows.forEach(r => {
    let date = extractDate(r.BookingDate || r.bookingdate || "");
    let products = (r.Product || "").split(",").map(x => x.trim()).filter(Boolean);

    products.forEach(t => {
      // Overall count
      overallMap.set(t, (overallMap.get(t) || 0) + 1);

      // Date-wise
      const key = date + "###" + t;
      dateMap.set(key, (dateMap.get(key) || 0) + 1);
    });
  });

  overallData = Array.from(overallMap.entries()).map(([test,count]) => ({ test,count }));
  overallData.sort((a,b) => b.count - a.count);

  datewiseData = Array.from(dateMap.entries()).map(([key,count]) => {
    const [date,test] = key.split("###");
    return { date,test,count };
  });

  datewiseData.sort((a,b) => {
    const d1 = new Date(a.date.split("/").reverse().join("-"));
    const d2 = new Date(b.date.split("/").reverse().join("-"));
    return d1 - d2 || a.test.localeCompare(b.test);
  });

  renderTables();
}

function renderTables() {
  const overallBody = document.querySelector("#overallTable tbody");
  overallBody.innerHTML = "";
  overallData.forEach((r,i) => {
    overallBody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${escape(r.test)}</td>
        <td>${r.count}</td>
      </tr>`;
  });

  const dateBody = document.querySelector("#datewiseTable tbody");
  dateBody.innerHTML = "";
  datewiseData.forEach((r,i) => {
    dateBody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${escape(r.date)}</td>
        <td>${escape(r.test)}</td>
        <td>${r.count}</td>
      </tr>`;
  });

  document.getElementById("downloadOverall").onclick = () => downloadCSV(overallData, ["Test Name","Total Count"]);
  document.getElementById("downloadDatewise").onclick = () => downloadCSV(datewiseData, ["Date","Test Name","Count"]);
}

function escape(v){
  return String(v).replace(/[&<>"']/g, c => (
    { "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]
  ));
}

function downloadCSV(data, headers) {
  let rows = [headers];

  data.forEach(r => {
    rows.push(Object.values(r).map(v => {
      let s = String(v);
      if (s.match(/[",\n]/)) s = '"' + s.replace(/"/g,'""') + '"';
      return s;
    }));
  });

  const csv = rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "export.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>

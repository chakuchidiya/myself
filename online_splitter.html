<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pivot Test Summary with Status Filter</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body { font-family:Arial; background:#eef2f7; padding:20px; }
  .container { max-width:1400px; margin:auto; background:white; padding:20px; border-radius:10px; }
  h1,h2 { text-align:center; }
  table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
  th,td { padding:8px; border:1px solid #ccc; text-align:center; }
  thead { background:#2563eb; color:white; }
  tr:nth-child(even){ background:#f1f5ff; }
  button { background:#2563eb; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; margin:10px 0; }
  select { padding:6px 10px; margin-left:10px; }
</style>
</head>

<body>
<div class="container">

  <h1>Test Summary</h1>

  <label><b>Upload Excel (.xlsx):</b>
    <input type="file" id="excelFile" accept=".xlsx">
  </label>

  <!-- Table 1 -->
  <h2>Table 1: Overall Test Count (Ignore Status)</h2>
  <button id="downloadOverall">Download Overall CSV</button>
  <table id="overallTable">
    <thead><tr><th>#</th><th>Name</th><th>Total Count</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Table 2 with Status Filter -->
  <h2>Table 2: Pivot â€” Test Row-wise, Date Column-wise</h2>

  <label><b>Filter by Status:</b></label>
  <select id="statusFilter">
    <option value="ALL">ALL</option>
  </select>

  <button id="downloadPivot">Download Pivot CSV</button>

  <table id="pivotTable">
    <thead id="pivotHead"></thead>
    <tbody id="pivotBody"></tbody>
  </table>

</div>

<script>
let allRows = [];
let uniqueDates = [];
let uniqueTests = [];
let uniqueStatuses = new Set();

document.getElementById("excelFile").addEventListener("change", handleFile);
document.getElementById("statusFilter").addEventListener("change", buildPivot);

function handleFile(e) {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = evt => {
    const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval:"" });

    allRows = rows;

    extractStatuses(rows);
    buildOverall(rows);
    buildPivot();
  };

  reader.readAsArrayBuffer(file);
}

// Extract date only (ignore time)
function extractDate(v) {
  if (!v) return "";
  if (!isNaN(v)) {
    const base = new Date(1899,11,30);
    return new Date(base.getTime() + v*86400000).toLocaleDateString("en-GB");
  }
  return v.split(" ")[0].trim();
}

// ---- TABLE 1: Overall (ignore status) ----
function buildOverall(rows) {
  const map = new Map();

  rows.forEach(r => {
    const tests = (r.Product || "").split(",").map(x => x.trim()).filter(Boolean);
    tests.forEach(t => {
      map.set(t, (map.get(t) || 0) + 1);
    });
  });

  const data = Array.from(map.entries())
    .map(([test,count]) => ({ test,count }))
    .sort((a,b) => b.count - a.count);

  const body = document.querySelector("#overallTable tbody");
  body.innerHTML = "";

  data.forEach((r,i) => {
    body.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${escapeCSV(r.test)}</td>
        <td>${r.count}</td>
      </tr>`;
  });

  document.getElementById("downloadOverall").onclick = () =>
    downloadCSV(data, ["Name","Total Count"]);
}

// ---- Extract unique statuses ----
function extractStatuses(rows) {
  uniqueStatuses.clear();

  rows.forEach(r => {
    let st = (r.Status || r.status || "").trim();
    if (st) uniqueStatuses.add(st);
  });

  const dropdown = document.getElementById("statusFilter");
  dropdown.innerHTML = `<option value="ALL">ALL</option>`;

  uniqueStatuses.forEach(s => {
    dropdown.innerHTML += `<option value="${s}">${s}</option>`;
  });
}

// ---- TABLE 2: Pivot (with status filter) ----
function buildPivot() {
  const statusFilter = document.getElementById("statusFilter").value;

  // Filter rows
  const rows = allRows.filter(r => {
    const st = (r.Status || r.status || "").trim();
    return statusFilter === "ALL" || st === statusFilter;
  });

  let dateSet = new Set();
  let testSet = new Set();

  const map = new Map(); // key = test###date -> count

  rows.forEach(r => {
    const date = extractDate(r.BookingDate || r.bookingdate || "");
    const tests = (r.Product || "").split(",").map(x => x.trim()).filter(Boolean);

    dateSet.add(date);
    tests.forEach(t => testSet.add(t));

    tests.forEach(t => {
      const key = t + "###" + date;
      map.set(key, (map.get(key) || 0) + 1);
    });
  });

  uniqueDates = Array.from(dateSet).sort((a,b) => new Date(a.split("/").reverse().join("-")) - new Date(b.split("/").reverse().join("-")));
  uniqueTests = Array.from(testSet).sort();

  // Build table header
  const head = document.getElementById("pivotHead");
  head.innerHTML = "<tr><th>Name</th>" +
                   uniqueDates.map(d=>`<th>${d}</th>`).join("") +
                   "<th>Total</th></tr>";

  // Build body
  const body = document.getElementById("pivotBody");
  body.innerHTML = "";

  uniqueTests.forEach(test => {
    let rowHTML = `<td>${escapeCSV(test)}</td>`;
    let testTotal = 0;

    uniqueDates.forEach(date => {
      const key = test + "###" + date;
      const val = map.get(key) || 0;
      testTotal += val;
      rowHTML += `<td>${val}</td>`;
    });

    rowHTML += `<td><b>${testTotal}</b></td>`;

    body.innerHTML += `<tr>${rowHTML}</tr>`;
  });

  document.getElementById("downloadPivot").onclick = downloadPivotCSV;
}

// -------- CSV ESCAPE ----------
function escapeCSV(v) {
  const s = String(v);
  if (/[" ,\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

// -------- DOWNLOAD PIVOT CSV ----------
function downloadPivotCSV() {
  let rows = [];

  // Header
  rows.push(["Name", ...uniqueDates, "Total"]);

  // Rows
  const trs = document.querySelectorAll("#pivotBody tr");
  trs.forEach(tr => {
    let cols = [...tr.children].map(td => escapeCSV(td.innerText));
    rows.push(cols);
  });

  const csv = rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "pivot.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
